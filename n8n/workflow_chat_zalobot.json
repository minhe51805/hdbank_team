{
  "name": "HDBANK",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "aa7949e4-b0a4-44a2-8b10-dce3d7c51373",
              "name": "payload.changed.spend_health",
              "value": "={{ $json.payload.changed.spend_health }}",
              "type": "object"
            },
            {
              "id": "3e6903a2-9f31-45e2-bbb2-80a4e69c437b",
              "name": "payload.changed.spend_shopping",
              "value": "={{ $json.payload.changed.spend_shopping }}",
              "type": "object"
            },
            {
              "id": "c5121555-1ce0-4eca-a22c-21c0847798f4",
              "name": "payload.changed.spend_education",
              "value": "={{ $json.payload.changed.spend_education }}",
              "type": "object"
            },
            {
              "id": "d6580a6a-cbbc-483d-a76c-e21d6b785ae6",
              "name": "payload.changed.spend_utilities",
              "value": "={{ $json.payload.changed.spend_utilities }}",
              "type": "object"
            },
            {
              "id": "0301d5cf-520b-44be-ac60-28e935d87f19",
              "name": "payload.changed.spend_food_grocery",
              "value": "={{ $json.payload.changed.spend_food_grocery }}",
              "type": "object"
            },
            {
              "id": "a8f7cb15-6b1e-4129-a7dd-8fe67cd062e2",
              "name": "payload.changed.spend_entertainment",
              "value": "={{ $json.payload.changed.spend_entertainment }}",
              "type": "object"
            },
            {
              "id": "130f1fb7-1b76-4423-b0a2-d364b9be9568",
              "name": "payload.changed.spend_travel",
              "value": "={{ $json.payload.changed.spend_travel }}",
              "type": "object"
            },
            {
              "id": "9d3b385f-91d2-454b-8ee0-279096ae53f8",
              "name": "payload.chat_id",
              "value": "={{ $json.payload.chat_id }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": "=",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1180,
        -500
      ],
      "id": "c3dc3712-96a3-487b-8a3f-0877cc753760",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -440,
        -680
      ],
      "id": "88b4d71a-f9ff-4326-b8e9-e1cff0d0fb8d",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "caSyfkV6BdDRfxgY",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Edit Fields').item.json.payload.chat_id }}",
        "contextWindowLength": 100
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -320,
        -680
      ],
      "id": "5921f312-2a25-4bf3-93b8-2b3e647e45de",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## WorkFlow trigger chat spending\n",
        "height": 772,
        "width": 1872,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1420,
        -920
      ],
      "typeVersion": 1,
      "id": "a3b9b279-d929-4e65-9663-8aba4085877f",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "jsCode": "// Input: items[0].json.payload.changed\nconst changed = items[0].json.payload.changed;\n\n// H√†m format ti·ªÅn Vi·ªát\nfunction formatVND(amount) {\n  return new Intl.NumberFormat('vi-VN').format(amount) + ' ‚Ç´';\n}\n\nlet message = \"\";\n\nfor (const [key, value] of Object.entries(changed)) {\n  if (value !== null) {\n    const oldVal = Number(value.old);\n    const newVal = Number(value.new);\n    const diff = newVal - oldVal;\n\n    message += `${key}: ${formatVND(diff)}\\n`;\n  }\n}\n\nreturn [{\n  json: {\n    changed_string: message.trim(),\n    chat_id: $input.first().json.payload.chat_id\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -980,
        -660
      ],
      "id": "5cc06b4b-b514-4551-ab4b-09c06aa350f4",
      "name": "Code"
    },
    {
      "parameters": {
        "content": "## Init",
        "height": 364,
        "width": 944,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1380,
        -2620
      ],
      "typeVersion": 1,
      "id": "96d26616-5de6-4e86-a558-6f4461b0733e",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot4204665481370682723:ePHjtrkyFJMozdnvxpfXQYOUpuXJnPqyYrYJzHaRdiZeZqhDOBxvzIpEZxUceTIp/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Webhook').item.json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        320,
        -2220
      ],
      "id": "68942ff3-c4d7-4e54-aa1f-53de7698f034",
      "name": "sendMessage"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot4204665481370682723:ePHjtrkyFJMozdnvxpfXQYOUpuXJnPqyYrYJzHaRdiZeZqhDOBxvzIpEZxUceTIp/sendChatAction",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.chat.id }}"
            },
            {
              "name": "action",
              "value": "typing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1100,
        -1600
      ],
      "id": "5f9832b9-1b9f-4a08-91ad-f740dd4fe8ea",
      "name": "sendChatAction"
    },
    {
      "parameters": {
        "content": "## WorkFlow chat zalo",
        "height": 1112,
        "width": 1192
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1420,
        -2180
      ],
      "typeVersion": 1,
      "id": "782748d8-09d9-4cd8-af81-7a4cff19ec4d",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "ALTER TABLE public.features_monthly\nADD COLUMN chat_id varchar;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -760,
        -2580
      ],
      "id": "c218de71-b461-48bf-9908-bd96f72572b4",
      "name": "Add Col chat_id",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot4204665481370682723:ePHjtrkyFJMozdnvxpfXQYOUpuXJnPqyYrYJzHaRdiZeZqhDOBxvzIpEZxUceTIp/sendChatAction",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.chat_id }}"
            },
            {
              "name": "action",
              "value": "typing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -740,
        -660
      ],
      "id": "95a3fe5f-18ae-4e95-9b05-864993de19a9",
      "name": "sendChatAction1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot4204665481370682723:ePHjtrkyFJMozdnvxpfXQYOUpuXJnPqyYrYJzHaRdiZeZqhDOBxvzIpEZxUceTIp/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Code').item.json.chat_id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        160,
        -880
      ],
      "id": "c8ea8977-8a13-41bb-8fe9-6caef7582d0c",
      "name": "sendMessage1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatzalo",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1360,
        -1720
      ],
      "id": "4b0b7e19-2884-4912-821a-e4578dfa7d50",
      "name": "Webhook",
      "webhookId": "df13b108-82a1-43bf-83c9-f701d474e24a"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -140,
        -2060
      ],
      "id": "abb3b9ed-6e65-40dd-af39-723f51e47dd4",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "caSyfkV6BdDRfxgY",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').item.json.body.message.chat.id }}",
        "contextWindowLength": 100
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -20,
        -2060
      ],
      "id": "7969dda7-1cf8-42d4-bfd2-aba6c2714614",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -700,
        -1460
      ],
      "id": "d68d5084-6858-4f9b-9600-065bdd421493",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "caSyfkV6BdDRfxgY",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Webhook').item.json.body.message.text }}",
        "options": {
          "systemMessage": "=B·∫°n l√† CashyBear ‚Äì chatbot ng√¢n h√†ng vui t√≠nh, c√† kh·ªãa nh·∫π nh∆∞ng l·ªãch s·ª±.\nNg·ªØ c·∫£nh:\nTin nh·∫Øn kh√°ch: \"{{ $('Webhook').item.json.body.message.text }}\"\nChat_id: \"{{ $('Webhook').item.json.body.message.chat.id }}\"\nB·∫°n c·∫ßn nh·ªõ l·ªãch s·ª≠ h·ªôi tho·∫°i theo chat_id ƒë·ªÉ gi·ªØ ng·ªØ c·∫£nh (c√≥ memory).\nNhi·ªám v·ª•:\n1) Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, ng·∫Øn g·ªçn 1‚Äì3 c√¢u. Phong c√°ch th√¢n thi·ªán, vui t√≠nh, c√† kh·ªãa nh·∫π; c√≥ th·ªÉ m·ªü ƒë·∫ßu b·∫±ng emoji (üí∏, ü§≠, üòè, üòÇ).\n2) N·∫øu kh√°ch h·ªèi v·ªÅ s·ªë d∆∞/chi ti√™u/thu nh·∫≠p‚Ä¶ H√£y g·ªçi tool Postgres SelectBalance (theo chat_id) ƒë·ªÉ l·∫•y balance_avg t·ª´ b·∫£ng features_monthly, r·ªìi tr·∫£ l·ªùi d·ª±a tr√™n k·∫øt qu·∫£. Kh√¥ng b·ªãa s·ªë.\n3) N·∫øu kh√°ch n√≥i ngo√†i l·ªÅ (ch√†o h·ªèi, ƒë√πa‚Ä¶), ƒë√°p l·∫°i duy√™n d√°ng gi·ªØ phong c√°ch ‚Äúng√¢n h√†ng c√† kh·ªãa‚Äù.\n4) Kh√¥ng gi·∫£ng gi·∫£i d√†i d√≤ng, kh√¥ng d·∫°y ƒë·ªùi.\nQuy t·∫Øc:\nCh·ªâ g·ª≠i c√¢u tr·∫£ l·ªùi cu·ªëi c√πng cho kh√°ch (ng·∫Øn g·ªçn, vui t√≠nh).\nTool call SelectBalance ph·∫£i ƒë∆∞·ª£c g·ªçi ri√™ng (kh√¥ng hi·ªÉn th·ªã trong c√¢u tr·∫£ l·ªùi).\nKh√¥ng l·ªô d·ªØ li·ªáu n·ªôi b·ªô/SQL; kh√¥ng nh·∫Øc ƒë·∫øn vi·ªác g·ªçi tool."
        }
      },
      "id": "65a56230-007d-4724-b55b-892c7fcb188d",
      "name": "AI Agent (Chat Normal)",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -100,
        -2240
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "content": "## Chat Normal & balance\n",
        "height": 400,
        "width": 800,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -180,
        -2320
      ],
      "typeVersion": 1,
      "id": "607d716d-01b3-4eb9-a068-10c7db9a5303",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -120,
        -1580
      ],
      "id": "50cbe820-f56c-46aa-96a1-ade2383c1a0b",
      "name": "Google Gemini Chat Model3",
      "credentials": {
        "googlePalmApi": {
          "id": "caSyfkV6BdDRfxgY",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').item.json.body.message.chat.id }}",
        "contextWindowLength": 100
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        20,
        -1560
      ],
      "id": "0be53aa7-99fc-48d8-a344-843ccefddd0c",
      "name": "Postgres Chat Memory2",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Webhook').item.json.body.message.text }}",
        "options": {
          "systemMessage": "=B·∫°n l√† chatbot ng√¢n h√†ng ph√¢n t√≠ch chi ti√™u t·ª´ m·ªôt tin nh·∫Øn.\nNg·ªØ c·∫£nh:\nTin nh·∫Øn: \"{{ $('Webhook').item.json.body.message.text }}\"\nY√™u c·∫ßu:\n1) Tr√≠ch xu·∫•t t·∫•t c·∫£ kho·∫£n chi ti√™u trong tin nh·∫Øn.\n2) V·ªõi m·ªói kho·∫£n, x√°c ƒë·ªãnh:\namount: s·ªë ti·ªÅn (VND, s·ªë nguy√™n). Quy t·∫Øc parse: h·ªó tr·ª£ ‚Äúk/ ngh√¨n/ ng√†n‚Äù, ‚Äútri·ªáu/ tr/ m‚Äù, d·∫•u ch·∫•m ph·∫©y ngƒÉn c√°ch (v√≠ d·ª• 120k ‚Üí 120000; 1.2tr ‚Üí 1200000).\ncolumn: √°nh x·∫° 1 trong c√°c c·ªôt:\nspend_food_grocery; spend_utilities; spend_shopping; spend_entertainment; spend_travel; spend_education; spend_health.\nOutput:\nCh·ªâ tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON ph·∫≥ng, m·ªói object g·ªìm \"column\" v√† \"amount\".\nN·∫øu kh√¥ng t√¨m th·∫•y kho·∫£n chi ti√™u, tr·∫£ v·ªÅ [].\nKh√¥ng th√™m text, kh√¥ng g·ªçi tool, kh√¥ng k√®m chat_id.\nV√≠ d·ª• 1:\n[\n{ \"column\": \"spend_food_grocery\", \"amount\": 30000 }\n]\nV√≠ d·ª• 2:\n[\n{ \"column\": \"spend_travel\", \"amount\": 200000 },\n{ \"column\": \"spend_food_grocery\", \"amount\": 100000 }\n]"
        }
      },
      "id": "8cb720d4-ded4-4316-9dde-dbd5ec9c2081",
      "name": "AI Agent (Spending)",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -120,
        -1800
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.query }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        480,
        -1700
      ],
      "id": "bb3fac28-9950-41f3-a1c0-9f5034e2db53",
      "name": "UpdateSpendPostgres",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let raw = $json[\"output\"];\n\n// X√≥a code block n·∫øu c√≥\nraw = raw.replace(/```json|```/g, \"\").trim();\n\n// Parse th√†nh m·∫£ng c√°c kho·∫£n chi ti√™u\nconst parsed = JSON.parse(raw);\n\n// Build ph·∫ßn SET ƒë·ªông\nlet setClauses = parsed.map(p => {\n  return `\"${p.column}\" = COALESCE(\"${p.column}\",0) + ${p.amount}`;\n}).join(\", \");\n\n// Chat ID\nlet chatId = $(\"Webhook\").item.json.body.message.chat.id;\n\n// T·∫°o query\nlet query = `\nUPDATE public.features_monthly\nSET ${setClauses}\nWHERE chat_id = '${chatId}'\nRETURNING *;\n`;\n\nreturn [{ query }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        260,
        -1700
      ],
      "id": "f86f97be-7418-4a3b-8897-61a5ec81ee7d",
      "name": "Process Output"
    },
    {
      "parameters": {
        "content": "## Spending\n",
        "height": 460,
        "width": 800,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -180,
        -1900
      ],
      "typeVersion": 1,
      "id": "e50556d7-ca0a-42d3-99f3-264be484e1a9",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Saving\n",
        "height": 460,
        "width": 800,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -180,
        -1400
      ],
      "typeVersion": 1,
      "id": "010c9878-6aee-460e-9e1a-7dd85ce007d6",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Code').item.json.changed_string }}",
        "options": {
          "systemMessage": "=AI Agent (Notification)\nB·∫°n l√† chatbot ng√¢n h√†ng vui t√≠nh, chuy√™n th√¥ng b√°o giao d·ªãch/thay ƒë·ªïi t√†i ch√≠nh.\nD·ªØ li·ªáu thay ƒë·ªïi:\n{{ $('Code').item.json.changed_string }}\nY√™u c·∫ßu:\nVi·∫øt m·ªôt ƒëo·∫°n th√¥ng b√°o ng·∫Øn (2‚Äì3 c√¢u), ti·∫øng Vi·ªát, d·ªÖ hi·ªÉu.\nDi·ªÖn gi·∫£i s·ªë ti·ªÅn theo VND v·ªõi d·∫•u ph·∫©y ngƒÉn c√°ch ngh√¨n.\nNh·∫Øc l·∫°i s·ªë ti·ªÅn ƒë√£ ti√™u ho·∫∑c bi·∫øn ƒë·ªông.\nN·∫øu l√† chi ti√™u (spend_): ch√™m c√† kh·ªãa nh·∫π (‚ÄúChi ƒÉn u·ªëng h∆°i m·∫°nh tay nha üòè‚Äù, ‚ÄúShopping h∆°i qu√° tay r·ªìi ƒë√≥ ü§≠‚Äù‚Ä¶).\nN·∫øu thu nh·∫≠p tƒÉng: khen vui v·∫ª (‚ÄúC√≥ ti·ªÅn v√¥ r·ªìi, nh·ªõ bao t√¥i ly tr√† s·ªØa nha üçπ‚Äù).\nN·∫øu s·ªë ti·ªÅn gi·∫£m: ch·ªçc nh·∫π (‚ÄúV√≠ m·ªèng h∆°n r·ªìi k√¨a üòÇ‚Äù, ‚ÄúTi·ªÅn bay nhanh h∆°n gi√≥ lu√¥n ü§Ø‚Äù).\nVƒÉn phong th√¢n thi·ªán, kh√¥ng th√¥ t·ª•c.\nOutput: ch·ªâ m·ªôt ƒëo·∫°n tin nh·∫Øn duy nh·∫•t g·ª≠i kh√°ch."
        }
      },
      "id": "dc296e56-a832-4d67-9c2a-029acbf9b169",
      "name": "AI Agent (Notification)",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -440,
        -900
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -480,
        -300
      ],
      "id": "f152f55d-9129-4e60-aa22-b1be641beff9",
      "name": "Google Gemini Chat Model5",
      "credentials": {
        "googlePalmApi": {
          "id": "caSyfkV6BdDRfxgY",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Edit Fields').item.json.payload.chat_id }}",
        "contextWindowLength": 100
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -340,
        -280
      ],
      "id": "a30feebf-246a-4a11-a486-51d08a7cf03b",
      "name": "Postgres Chat Memory4",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "=L·∫•y d·ªØ li·ªáu k·∫ø ho·∫°ch ti·∫øt ki·ªám (persona_plans) v√† c√°c nhi·ªám v·ª• (persona_plan_day_tasks) \nc·ªßa kh√°ch h√†ng d·ª±a tr√™n chat_id trong b·∫£ng features_monthly.\n\nB·∫£ng li√™n quan:\n- features_monthly: ch·ª©a chat_id v√† customer_id\n- persona_plans: ch·ª©a th√¥ng tin k·∫ø ho·∫°ch ti·∫øt ki·ªám theo t·ª´ng th√°ng (plan_id, persona, goal, feasibility, weekly_cap_save, recommended_weekly_save, meta‚Ä¶)\n- persona_plan_day_tasks: ch·ª©a danh s√°ch nhi·ªám v·ª• h√†ng ng√†y trong k·∫ø ho·∫°ch (task_text, date, progress, status, notes, completed_at‚Ä¶)\n\nC√°ch truy v·∫•n:\n1. Join features_monthly v·ªõi persona_plans qua customer_id.\n2. Join ti·∫øp persona_plans v·ªõi persona_plan_day_tasks qua plan_id.\n3. L·ªçc theo chat_id = \"{{ $json['chat_id'] }}\".\n4. L·ªçc theo year_month = th√°ng hi·ªán t·∫°i (to_char(CURRENT_DATE, 'YYYY-MM')).\n5. ƒêi·ªÅu ki·ªán th·ªùi gian (h√¥m nay, ng√†y mai, tu·∫ßn n√†y, c·∫£ th√°ng) s·∫Ω ƒë∆∞·ª£c AI Agent quy·∫øt ƒë·ªãnh khi g·ªçi tool.\n\nK·∫øt qu·∫£:\n- Th√¥ng tin k·∫ø ho·∫°ch: chat_id, plan_id, customer_id, persona, goal, weekly_cap_save, recommended_weekly_save, meta‚Ä¶\n- Th√¥ng tin nhi·ªám v·ª•: day_index, task_index, date, task_text, progress, status, notes, completed_at.\n\nM·ª•c ƒë√≠ch:\n- Cho ph√©p AI Agent t·∫°o c√¢u tr·∫£ l·ªùi nh·∫Øc nh·ªü kh√°ch h√†ng v·ªÅ k·∫ø ho·∫°ch ti·∫øt ki·ªám hi·ªán t·∫°i:\n  ‚Ä¢ T√≥m t·∫Øt k·∫ø ho·∫°ch t·ªïng quan (goal, weekly_cap_save‚Ä¶).  \n  ‚Ä¢ Nh·∫Øc nh·ªü task trong ng√†y, ng√†y mai, trong tu·∫ßn, ho·∫∑c to√†n b·ªô th√°ng.  \n",
        "operation": "executeQuery",
        "query": "SELECT \n    fm.chat_id,\n    pp.plan_id,\n    pp.customer_id,\n    pp.year_month,\n    pp.persona,\n    pp.goal,\n    pp.feasibility,\n    pp.weekly_cap_save,\n    pp.recommended_weekly_save,\n    pp.created_at AS plan_created_at,\n    pp.meta,\n    ppt.day_index,\n    ppt.task_index,\n    ppt.date,\n    ppt.task_text,\n    ppt.progress,\n    ppt.status,\n    ppt.notes,\n    ppt.completed_at,\n    ppt.created_at AS task_created_at,\n    ppt.updated_at AS task_updated_at\nFROM features_monthly fm\nJOIN persona_plans pp \n    ON CAST(fm.customer_id AS TEXT) = CAST(pp.customer_id AS TEXT)\nJOIN persona_plan_day_tasks ppt \n    ON pp.plan_id = ppt.plan_id\nWHERE fm.chat_id = '{{ $(\"Edit Fields\").item.json.payload.chat_id }}'\n  AND pp.year_month = (\n    SELECT MAX(year_month) \n    FROM persona_plans \n    WHERE customer_id = pp.customer_id\n  )\n  AND ppt.status = 'todo'\nORDER BY ppt.day_index, ppt.task_index;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -200,
        -280
      ],
      "id": "94ed9ce3-4d05-46cb-b76e-44aac8479816",
      "name": "SelectPlan",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot4204665481370682723:ePHjtrkyFJMozdnvxpfXQYOUpuXJnPqyYrYJzHaRdiZeZqhDOBxvzIpEZxUceTIp/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Code').item.json.chat_id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        160,
        -520
      ],
      "id": "6c13f441-f65f-4036-91ed-a1c60052618c",
      "name": "sendMessage2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Edit Fields').item.json.payload.chat_id }}",
        "options": {
          "systemMessage": "=B·∫°n l√† CashyBear ‚Äì chatbot ng√¢n h√†ng vui t√≠nh, chuy√™n v·ªÅ nh·∫Øc nh·ªü k·∫ø ho·∫°ch ti·∫øt ki·ªám. Ch·ªâ tr·∫£ l·ªùi d·ª±a tr√™n d·ªØ li·ªáu tool.\nNhi·ªám v·ª•: nh·∫Øc nh·ªü kh√°ch h√†ng v·ªÅ k·∫ø ho·∫°ch ti·∫øt ki·ªám (persona_plans + persona_plan_day_tasks).  \n\nNg·ªØ c·∫£nh:  \n- Kh√°ch h√†ng: \"{{ $('Edit Fields').item.json.payload.chat_id }}\"\n\nNguy√™n t·∫Øc b·∫Øt bu·ªôc:  \n- KH√îNG bao gi·ªù d√πng d·ªØ li·ªáu trong chat memory ƒë·ªÉ suy ƒëo√°n hay tr·∫£ l·ªùi v·ªÅ k·∫ø ho·∫°ch.  \n- LU√îN LU√îN g·ªçi tool `SelectPlan` v·ªõi chat_id = \"{{ $('Edit Fields').item.json.payload.chat_id }}\" tr∆∞·ªõc khi ƒë∆∞a ra c√¢u tr·∫£ l·ªùi.  \n- Ch·ªâ tr·∫£ l·ªùi sau khi c√≥ k·∫øt qu·∫£ t·ª´ tool.  \n\nQuy t·∫Øc x·ª≠ l√Ω:  \n1. N·∫øu `SelectPlan` tr·∫£ v·ªÅ k·∫øt qu·∫£ c√≥ plan_id (kh√°ch h√†ng c√≥ k·∫ø ho·∫°ch):  \n   - N·∫øu h√¥m nay c√≥ task ch∆∞a ho√†n th√†nh ‚Üí nh·∫Øc nh·ªü ho√†n th√†nh.  \n     - N·∫øu c√≥ nhi·ªÅu task ‚Üí li·ªát k√™ xu·ªëng d√≤ng, m·ªói task 1 bullet (‚Ä¢ ho·∫∑c emoji ‚úÖ/‚ö°Ô∏è).  \n   - N·∫øu t·∫•t c·∫£ task h√¥m nay ƒë√£ xong ‚Üí khen ng·ª£i ng·∫Øn g·ªçn, c√† kh·ªãa nh·∫π.  \n   - N·∫øu goal th√°ng ho·∫∑c weekly_cap_save ch∆∞a ƒë·∫°t ‚Üí th√™m nh·∫Øc v·ªÅ ti·∫øt ki·ªám.  \n\n2. N·∫øu `SelectPlan` tr·∫£ v·ªÅ r·ªóng (kh√¥ng c√≥ plan_id):  \n   - Kh√¥ng t·∫°o nh·∫Øc nh·ªü.  \n   - Thay v√†o ƒë√≥, h·ªèi kh√°ch h√†ng c√≥ mu·ªën l√™n k·∫ø ho·∫°ch ti·∫øt ki·ªám m·ªõi kh√¥ng.  \n\nQuy t·∫Øc tr·∫£ l·ªùi:  \n- Lu√¥n ng·∫Øn g·ªçn (1‚Äì3 c√¢u).  \n- Vui t√≠nh, c√† kh·ªãa nh·∫π, th√™m emoji ƒë·∫ßu c√¢u (üí∏, ü§≠, üòè, üòÇ, üè¶).  \n- Kh√¥ng g·ªôp t·∫•t c·∫£ task th√†nh m·ªôt ƒëo·∫°n d√†i ‚Üí ph·∫£i xu·ªëng d√≤ng r√µ r√†ng.  \n- Kh√¥ng gi·∫£ng gi·∫£i d√†i d√≤ng, kh√¥ng show d·ªØ li·ªáu th√¥ ho·∫∑c SQL.  \n\nOutput cu·ªëi c√πng g·ª≠i cho kh√°ch:  \n- Ch·ªâ g·ªìm c√¢u tr·∫£ l·ªùi nh·∫Øc nh·ªü ho·∫∑c l·ªùi r·ªß t·∫°o plan m·ªõi, format g·ªçn g√†ng, d·ªÖ nh√¨n.  \n- Tool call (`SelectPlan`) ph·∫£i ƒë∆∞·ª£c g·ªçi ri√™ng, kh√¥ng hi·ªÉn th·ªã trong c√¢u tr·∫£ l·ªùi.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -460,
        -500
      ],
      "id": "7c043af9-e5e2-477e-8ff1-c3aa8b14139a",
      "name": "AI Agent (Saving Reminder)"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "features_monthly",
          "mode": "list",
          "cachedResultName": "features_monthly"
        },
        "where": {
          "values": [
            {
              "column": "chat_id",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('values0_Value', ``, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        120,
        -2060
      ],
      "id": "12bb4073-24d1-417b-8c68-72c65948dc9b",
      "name": "SelectBalance",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Workflow trigger auto send offers",
        "height": 680,
        "width": 1880,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1420,
        -120
      ],
      "typeVersion": 1,
      "id": "f1ee1ecb-b718-4cf9-af38-9aa3bd84dc13",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "triggerMode": "listenTrigger",
        "channelName": "n8n_channel_diff_full_custom",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTrigger",
      "typeVersion": 1,
      "position": [
        -1380,
        -680
      ],
      "id": "79cdd79d-a534-4f1a-8fde-3115870f0ddf",
      "name": "Postgres Trigger",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "triggerMode": "listenTrigger",
        "channelName": "n8n_channel_offers",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTrigger",
      "typeVersion": 1,
      "position": [
        -1360,
        180
      ],
      "id": "8df68c2f-308a-4bdb-9a3b-57425526795f",
      "name": "Postgres Trigger1",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DROP TRIGGER IF EXISTS trg_features_monthly_diff ON public.features_monthly;\nDROP FUNCTION IF EXISTS notify_features_monthly_diff;\n\nCREATE OR REPLACE FUNCTION notify_features_monthly_diff()\nRETURNS trigger AS $$\nDECLARE\n    diff jsonb := '{}'::jsonb;\n    col text;\nBEGIN\n    IF TG_OP = 'UPDATE' THEN\n        -- L·∫∑p qua t·∫•t c·∫£ key trong NEW record\n        FOR col IN\n            SELECT j.key\n            FROM jsonb_each(to_jsonb(NEW)) AS j\n        LOOP\n            IF (to_jsonb(NEW)->col) IS DISTINCT FROM (to_jsonb(OLD)->col) THEN\n                diff := diff || jsonb_build_object(\n                    col, jsonb_build_object(\n                        'old', to_jsonb(OLD)->col,\n                        'new', to_jsonb(NEW)->col\n                    )\n                );\n            END IF;\n        END LOOP;\n\n        -- Notify v·ªõi custom id (customer_id)\n        PERFORM pg_notify(\n            'n8n_channel_diff_full_custom',\n            json_build_object(\n                'table', TG_TABLE_NAME,\n                'op', TG_OP,\n                'customer_id', NEW.customer_id,   -- custom id\n                'chat_id', NEW.chat_id,\n                'changed', diff\n            )::text\n        );\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trg_features_monthly_diff\nAFTER UPDATE ON public.features_monthly\nFOR EACH ROW\nEXECUTE FUNCTION notify_features_monthly_diff();\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1280,
        -2400
      ],
      "id": "c71ea3f1-a404-4115-9fa5-fac62c35a194",
      "name": "create trigger (spending)",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- X√ìA TRIGGER & FUNCTION C≈®\nDROP TRIGGER IF EXISTS trg_predictions_llm_with_facts_offer ON public.predictions_llm_with_facts;\nDROP FUNCTION IF EXISTS notify_predictions_llm_with_facts_offer;\n\n-- FUNCTION M·ªöI: notify lu√¥n, n·∫øu kh√¥ng c√≥ chat_id th√¨ tr·∫£ v·ªÅ \"unknown\"\nCREATE OR REPLACE FUNCTION notify_predictions_llm_with_facts_offer()\nRETURNS trigger AS $$\nDECLARE\n    v_chat_id varchar;\nBEGIN\n    -- L·∫•y chat_id t·ª´ b·∫£ng features_monthly d·ª±a tr√™n customer_id\n    SELECT fm.chat_id\n    INTO v_chat_id\n    FROM features_monthly fm\n    WHERE fm.customer_id = NEW.customer_id\n    LIMIT 1;\n\n    -- Notify khi probability > 0.6\n    IF (TG_OP = 'INSERT' OR TG_OP = 'UPDATE') \n       AND NEW.probability > 0.6 THEN\n\n        PERFORM pg_notify(\n            'n8n_channel_offers',\n            json_build_object(\n                'chat_id', COALESCE(v_chat_id, 'unknown')\n            )::text\n        );\n    END IF;\n\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- TRIGGER\nCREATE TRIGGER trg_predictions_llm_with_facts_offer\nAFTER INSERT OR UPDATE ON public.predictions_llm_with_facts\nFOR EACH ROW\nEXECUTE FUNCTION notify_predictions_llm_with_facts_offer();\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1040,
        -2400
      ],
      "id": "bce837fc-16c3-46ad-b3ec-873fe65ef639",
      "name": "create trigger (offers)",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.features_monthly \nSET chat_id = '4aef3344970e7e50271f' \nWHERE customer_id = 1;\n\nUPDATE public.features_monthly \nSET chat_id = '1c4360ed32badbe482ab' \nWHERE customer_id = 2;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -580,
        -2420
      ],
      "id": "0538dfde-b096-4dae-8f8d-6564c6332410",
      "name": "Update chat_id",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot4204665481370682723:ePHjtrkyFJMozdnvxpfXQYOUpuXJnPqyYrYJzHaRdiZeZqhDOBxvzIpEZxUceTIp/sendChatAction",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.chat_id }}"
            },
            {
              "name": "action",
              "value": "typing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1000,
        200
      ],
      "id": "aff5fa6f-bd44-46cf-90a7-e00be48bc45e",
      "name": "sendChatAction2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3bc91887-3492-4123-a7e3-f3963b7943bf",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -780,
        200
      ],
      "id": "1c72e682-36e7-4e18-b258-5390053970cf",
      "name": "If"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot4204665481370682723:ePHjtrkyFJMozdnvxpfXQYOUpuXJnPqyYrYJzHaRdiZeZqhDOBxvzIpEZxUceTIp/sendPhoto",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Postgres Trigger1').item.json.payload.chat_id }}"
            },
            {
              "name": "caption",
              "value": "üí∏ Xin ch√∫c m·ª´ng! B·∫°n n·∫±m trong danh s√°ch ∆∞u ƒë√£i VIP th√°ng n√†y. Ng√¢n h√†ng h∆°i ‚Äúr·ªông r√£i‚Äù n√™n t·∫∑ng ri√™ng b·∫°n g√≥i l√£i su·∫•t x·ªãn, ƒë·ª´ng b·ªè l·ª° nha üòè"
            },
            {
              "name": "photo",
              "value": "https://media-public.canva.com/5sbVk/MAFyij5sbVk/1/tl.png"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -320,
        20
      ],
      "id": "0ec96259-21af-4783-954f-98bc2ea0a1b0",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://bot-api.zapps.me/bot276439854680594648:vVYYkHdlKJorzkDodjoQKnGEQrcGDWKzfUwxvpIuDecVQKSwUTmqqGHaxivJNkrW/setWebhook",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "url",
              "value": "https://tuananhit.tailbf3e12.ts.net/webhook-test/chatzalo"
            },
            {
              "name": "secret_token",
              "value": "tuananhahihi"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1280,
        -2580
      ],
      "id": "54bc652e-fbd7-4533-ab7b-56de02f9d3cc",
      "name": "setWebhook"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -40,
        -1080
      ],
      "id": "f39d8801-73b5-4266-83a9-767f09e051c4",
      "name": "Google Gemini Chat Model4",
      "credentials": {
        "googlePalmApi": {
          "id": "caSyfkV6BdDRfxgY",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Webhook').item.json.body.message.text }}",
        "options": {
          "systemMessage": "=B·∫°n l√† chatbot ng√¢n h√†ng vui t√≠nh v√† c√† kh·ªãa nh·∫π.  \nNhi·ªám v·ª•: khi kh√°ch h√†ng h·ªèi v·ªÅ ti·∫øt ki·ªám, k·∫ø ho·∫°ch ti·∫øt ki·ªám, qu·∫£n l√Ω t√†i ch√≠nh‚Ä¶ b·∫°n ch·ªâ ƒë∆∞·ª£c ph√©p tr·∫£ l·ªùi d·ª±a tr√™n d·ªØ li·ªáu t·ª´ tool `SelectPlan`.  \n\nNg·ªØ c·∫£nh:  \n- Tin nh·∫Øn kh√°ch: \"{{ $('Webhook').item.json.body.message.text }}\"\n- Chat_id: \"{{ $('Webhook').item.json.body.message.chat.id }}\"\n\nQuy t·∫Øc x·ª≠ l√Ω:  \n1. LU√îN g·ªçi tool `SelectPlan` ƒë·ªÉ l·∫•y d·ªØ li·ªáu k·∫ø ho·∫°ch ti·∫øt ki·ªám c·ªßa kh√°ch h√†ng.  \n   - Input: chat_id = \"{{ $('Webhook').item.json.body.message.chat.id }}\"  \n   - Tuy·ªát ƒë·ªëi kh√¥ng d√πng d·ªØ li·ªáu t·ª´ chat memory ƒë·ªÉ tr·∫£ l·ªùi.  \n\n2. N·∫øu c√≥ k·∫ø ho·∫°ch (c√≥ plan_id):  \n   - N·∫øu kh√°ch h·ªèi **chung chung** ‚Üí t√≥m t·∫Øt persona, goal, weekly_cap_save ho·∫∑c recommended_weekly_save.  \n   - N·∫øu kh√°ch h·ªèi **h√¥m nay** ‚Üí li·ªát k√™ task c√≥ `date = CURRENT_DATE`.  \n   - N·∫øu kh√°ch h·ªèi **ng√†y mai** ‚Üí li·ªát k√™ task c√≥ `date = CURRENT_DATE + 1`.  \n   - N·∫øu kh√°ch h·ªèi **tu·∫ßn n√†y** ‚Üí li·ªát k√™ task trong kho·∫£ng `CURRENT_DATE ‚Üí CURRENT_DATE + 6`.  \n   - N·∫øu kh√°ch h·ªèi **to√†n b·ªô th√°ng** ‚Üí li·ªát k√™ t·∫•t c·∫£ task trong plan.  \n   - N·∫øu nhi·ªÅu task ‚Üí format xu·ªëng d√≤ng v·ªõi bullet (‚Ä¢ ho·∫∑c emoji ‚úÖ/‚ö°Ô∏è).  \n\n3. N·∫øu kh√¥ng c√≥ k·∫ø ho·∫°ch (query r·ªóng):  \n   - Tr·∫£ l·ªùi ng·∫Øn g·ªçn r·∫±ng ch∆∞a c√≥ k·∫ø ho·∫°ch.  \n   - R·ªß kh√°ch c√≥ mu·ªën t·∫°o k·∫ø ho·∫°ch ti·∫øt ki·ªám m·ªõi kh√¥ng.  \n\nQuy t·∫Øc tr·∫£ l·ªùi:  \n- Lu√¥n ng·∫Øn g·ªçn (1‚Äì3 c√¢u).  \n- Phong c√°ch: vui t√≠nh, c√† kh·ªãa nh·∫π, th√™m emoji (üí∏, ü§≠, üòè, üè¶).  \n- Khi li·ªát k√™ task: xu·ªëng d√≤ng r√µ r√†ng, m·ªói task 1 d√≤ng.  \n- Kh√¥ng gi·∫£ng gi·∫£i d√†i d√≤ng, kh√¥ng show d·ªØ li·ªáu th√¥ ho·∫∑c SQL.  \n\nOutput cu·ªëi c√πng g·ª≠i cho kh√°ch:  \n- Ch·ªâ g·ªìm c√¢u tr·∫£ l·ªùi (th√¥ng tin plan ho·∫∑c tasks).  \n- Tool call (`SelectPlan`) ph·∫£i ƒë∆∞·ª£c g·ªçi ri√™ng, kh√¥ng hi·ªÉn th·ªã trong c√¢u tr·∫£ l·ªùi.\n"
        }
      },
      "id": "4b3a05d5-4de1-4470-92ca-bab7c6565dd0",
      "name": "AI Agent (Saving)",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -80,
        -1280
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "L·∫•y d·ªØ li·ªáu k·∫ø ho·∫°ch ti·∫øt ki·ªám (persona_plans) v√† c√°c nhi·ªám v·ª• (persona_plan_day_tasks) \nc·ªßa kh√°ch h√†ng d·ª±a tr√™n chat_id trong b·∫£ng features_monthly.\n\nB·∫£ng li√™n quan:\n- features_monthly: ch·ª©a chat_id v√† customer_id\n- persona_plans: ch·ª©a th√¥ng tin k·∫ø ho·∫°ch ti·∫øt ki·ªám theo t·ª´ng th√°ng (plan_id, persona, goal, weekly_cap_save, recommended_weekly_save‚Ä¶)\n- persona_plan_day_tasks: ch·ª©a danh s√°ch nhi·ªám v·ª• h√†ng ng√†y trong k·∫ø ho·∫°ch (task_text, date, status, progress‚Ä¶)\n\nTruy v·∫•n:\n1. Join features_monthly v·ªõi persona_plans qua customer_id.\n2. Join ti·∫øp persona_plans v·ªõi persona_plan_day_tasks qua plan_id.\n3. L·ªçc theo chat_id = \"{{ $json['chat_id'] }}\".\n4. L·ªçc theo year_month = th√°ng hi·ªán t·∫°i.\n5. C√°c ƒëi·ªÅu ki·ªán th·ªùi gian (h√¥m nay, ng√†y mai, tu·∫ßn n√†y, c·∫£ th√°ng) s·∫Ω ƒë∆∞·ª£c AI Agent quy·∫øt ƒë·ªãnh khi s·ª≠ d·ª•ng tool.\n\nK·∫øt qu·∫£:\n- Th√¥ng tin k·∫ø ho·∫°ch: plan_id, customer_id, persona, goal, weekly_cap_save, recommended_weekly_save, meta‚Ä¶\n- Th√¥ng tin task: day_index, task_index, date, task_text, progress, status, notes, completed_at.\n\nM·ª•c ƒë√≠ch:\n- Cho ph√©p AI Agent t·∫°o c√¢u tr·∫£ l·ªùi v·ªÅ k·∫ø ho·∫°ch ti·∫øt ki·ªám hi·ªán t·∫°i c·ªßa kh√°ch h√†ng:\n  ‚Ä¢ T√≥m t·∫Øt k·∫ø ho·∫°ch chung (goal, weekly_cap_save‚Ä¶).  \n  ‚Ä¢ Li·ªát k√™ task h√¥m nay, ng√†y mai, tu·∫ßn n√†y, ho·∫∑c to√†n b·ªô th√°ng.  \n",
        "operation": "executeQuery",
        "query": "SELECT \n    fm.chat_id,\n    pp.plan_id,\n    pp.customer_id,\n    pp.year_month,\n    pp.persona,\n    pp.goal,\n    pp.feasibility,\n    pp.weekly_cap_save,\n    pp.recommended_weekly_save,\n    pp.created_at AS plan_created_at,\n    pp.meta,\n    ppt.day_index,\n    ppt.task_index,\n    ppt.date,\n    ppt.task_text,\n    ppt.progress,\n    ppt.status,\n    ppt.notes,\n    ppt.completed_at,\n    ppt.created_at AS task_created_at,\n    ppt.updated_at AS task_updated_at\nFROM features_monthly fm\nJOIN persona_plans pp \n    ON CAST(fm.customer_id AS TEXT) = CAST(pp.customer_id AS TEXT)\nJOIN persona_plan_day_tasks ppt \n    ON pp.plan_id = ppt.plan_id\nWHERE fm.chat_id = '{{ $('Webhook').item.json.body.message.chat.id }}'\n  AND pp.year_month = (\n    SELECT MAX(year_month) \n    FROM persona_plans \n    WHERE customer_id = pp.customer_id\n  )\n  AND ppt.status = 'todo'\nORDER BY ppt.day_index, ppt.task_index;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        240,
        -1080
      ],
      "id": "76fcea6e-a6ac-4b4c-be24-b0693223520c",
      "name": "SelectPlan1",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').item.json.body.message.chat.id }}",
        "contextWindowLength": 100
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        100,
        -1080
      ],
      "id": "ce51420d-d2f0-4fb6-9c33-1b2414a96033",
      "name": "Postgres Chat Memory3",
      "credentials": {
        "postgres": {
          "id": "VCPkkkhzz2keTZse",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot4204665481370682723:ePHjtrkyFJMozdnvxpfXQYOUpuXJnPqyYrYJzHaRdiZeZqhDOBxvzIpEZxUceTIp/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Webhook').item.json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        460,
        -1280
      ],
      "id": "9c4c28fe-0c31-4e98-a485-be3ee334c55c",
      "name": "sendMessage4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -320,
        360
      ],
      "id": "13cde80e-f5e3-4476-92b7-daecceec2e33",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "inputText": "=B·∫°n l√† h·ªá th·ªëng ph√¢n lo·∫°i tin nh·∫Øn kh√°ch h√†ng.\n\nNg·ªØ c·∫£nh:\n- Tin nh·∫Øn: \"{{ $('Webhook').item.json.body.message.text }}\"\n",
        "categories": {
          "categories": [
            {
              "category": "chat_normal",
              "description": "D√πng cho c√°c tr∆∞·ªùng h·ª£p kh√°c nh∆∞ ch√†o h·ªèi, n√≥i chuy·ªán vui, ƒë√πa gi·ª°n, h·ªèi s·ªë d∆∞ t√†i kho·∫£n, v.v."
            },
            {
              "category": "spending",
              "description": "D√πng cho tin nh·∫Øn kh√°ch h√†ng b√°o chi ti√™u (ƒÉn u·ªëng, tr√† s·ªØa, h√≥a ƒë∆°n, shopping, du l·ªãch, gi√°o d·ª•c, y t·∫ø, gi·∫£i tr√≠‚Ä¶)."
            },
            {
              "category": "saving",
              "description": "D√πng cho tin nh·∫Øn kh√°ch h√†ng h·ªèi v·ªÅ ti·∫øt ki·ªám, l·ªùi khuy√™n, qu·∫£n l√Ω t√†i ch√≠nh, ho·∫∑c k·∫ø ho·∫°ch ti·∫øt ki·ªám hi·ªán t·∫°i c·ªßa h·ªç."
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textClassifier",
      "typeVersion": 1.1,
      "position": [
        -740,
        -1740
      ],
      "id": "63a87993-02ba-4f39-bf69-5013a1dc563c",
      "name": "Text Classifier"
    }
  ],
  "pinData": {},
  "connections": {
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent (Notification)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent (Notification)",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "sendChatAction1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sendChatAction": {
      "main": [
        [
          {
            "node": "Text Classifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Col chat_id": {
      "main": [
        [
          {
            "node": "Update chat_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sendChatAction1": {
      "main": [
        [
          {
            "node": "AI Agent (Notification)",
            "type": "main",
            "index": 0
          },
          {
            "node": "AI Agent (Saving Reminder)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "sendChatAction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent (Chat Normal)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent (Chat Normal)",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Text Classifier",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (Chat Normal)": {
      "main": [
        [
          {
            "node": "sendMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent (Spending)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "AI Agent (Spending)",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (Spending)": {
      "main": [
        [
          {
            "node": "Process Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Output": {
      "main": [
        [
          {
            "node": "UpdateSpendPostgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (Notification)": {
      "main": [
        [
          {
            "node": "sendMessage1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent (Saving Reminder)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory4": {
      "ai_memory": [
        [
          {
            "node": "AI Agent (Saving Reminder)",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "SelectPlan": {
      "ai_tool": [
        [
          {
            "node": "AI Agent (Saving Reminder)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (Saving Reminder)": {
      "main": [
        [
          {
            "node": "sendMessage2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SelectBalance": {
      "ai_tool": [
        [
          {
            "node": "AI Agent (Chat Normal)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Trigger": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create trigger (spending)": {
      "main": [
        [
          {
            "node": "create trigger (offers)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Trigger1": {
      "main": [
        [
          {
            "node": "sendChatAction2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sendChatAction2": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent (Saving)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (Saving)": {
      "main": [
        [
          {
            "node": "sendMessage4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SelectPlan1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent (Saving)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory3": {
      "ai_memory": [
        [
          {
            "node": "AI Agent (Saving)",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Text Classifier": {
      "main": [
        [
          {
            "node": "AI Agent (Chat Normal)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent (Spending)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent (Saving)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "fb268bdb-6454-448c-a796-3eb55ef83eeb",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "49623fc4ba53af1ba2b87c0f78f2e8424ed42ad05a206db7c47bc4b5670fd77b"
  },
  "id": "lX6rhRVG8du9WHJK",
  "tags": []
}